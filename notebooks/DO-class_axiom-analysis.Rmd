---
title: "Analysis of EQ/subClassOf axiom changes in releases"
output:
    html_notebook:
        toc: true
        toc_float: true
        df_print: paged
        code_folding: hide
---

```{r setup, include = FALSE}
library(here)
library(tidyverse)
library(googlesheets4)
```

```{r custom_functions, include = FALSE}
# identify unexpected id/axiom values
identify_unexpected <- function(df, id = id, axiom = axiom) {
    filter(
        df,
        stringr::str_detect({{ id }}, "[^A-Za-z0-9:()_ ]") |
            stringr::str_detect({{ axiom }}, "[^A-Za-z0-9:()_ ]")
    )
}
identify_unexpected_id <- function(df, id = id, axiom = axiom) {
    filter(
        df,
        stringr::str_detect({{ id }}, "[^A-Za-z0-9:()_ ]")
    )
}
identify_unexpected_axiom <- function(df, id = id, axiom = axiom) {
    filter(
        df,
        stringr::str_detect({{ axiom }}, "[^A-Za-z0-9:()_ ]")
    )
}

# replace obo URIs with CURIEs
obo_uri_to_curie <- function(x) {
    stringr::str_replace_all(
        x,
        "<http://purl.obolibrary.org/obo/([^> ]*)>",
        "obo:\\1"
    )
}

arrange_by_tag <- function(df) {
    dplyr::left_join(df, tag_df, by = "tag") %>%
        dplyr::arrange(datetime) %>%
        dplyr::select(-datetime)
}
```


# Load data

Axiom data was extracted from a local copy of the HumanDiseaseOntology repository using `scripts/DO_tags-extract_class_axiom.py` and saved in `data/DO_release`.

```{r data_paths}
axiom_path <- here::here("data/DO_release/DO-class_axiom-by_tag-raw.csv")
tag_path <- here::here("data/DO_release/DO-tags.csv")
```

```{r load_data}
axiom_raw <- readr::read_csv(axiom_path, show_col_types = FALSE) %>%
    dplyr::rename(tag = ...1, index = ...2)

tag_df <- readr::read_csv(
    tag_path,
    col_names = c("tag", "datetime"),
    skip = 1,
    show_col_types = FALSE
) %>%
    dplyr::arrange(datetime)
```


# Examine Data to Identify Issues

Unexpected characters (likely caused by typos) could be a problem. Exploring those in DOIDs and axioms by excluding expected characters...


## IDs

```{r}
# filter by unexpected values in id
unexpected_id <- axiom_raw %>%
    identify_unexpected_id()
unexpected_id
```

Those mostly look like OBO URIs (which are not a problem).

After converting OBO URIs to CURIEs ...

```{r}
# these are removed by converting  (so these are fine)
unexpected_id %>%
    dplyr::mutate(id = obo_uri_to_curie(id)) %>%
    identify_unexpected_id()
```

**...there are no longer any unexpected characters in the IDs**, though there may still be typos.


## Axioms

There will probably be OBO URIs here too. Those are excluded at the start.
```{r}
unexpected_axiom <- axiom_raw %>%
    dplyr::mutate(axiom = obo_uri_to_curie(axiom)) %>%
    identify_unexpected_axiom()
unexpected_axiom
```

There are still _a lot_ of unexpected characters. Some appear to be from SO as `so#` (e.g. `derives_from`, `has_origin`). I checked and bith of those are legitimate classes in SO. Are there any more SO classes with `#`?

```{r}
unexpected_axiom$axiom %>%
    stringr::str_extract_all("so#[a-zA-z_]+") %>%
    unlist() %>%
    unique()
```

Doesn't look like it. After temporarily removing those...
```{r}
unexpected_axiom <- unexpected_axiom %>%
    dplyr::mutate(axiom = stringr::str_remove_all(axiom, "so#[a-zA-z_]+")) %>%
    identify_unexpected_axiom()
unexpected_axiom
```

...there is much improvement but still a surprising number of unexpected characters. What is that `doid#derives_from`? That doesn't look like something that should be there. What release tags is it associated with?

```{r}
unexpected_axiom %>%
    filter(str_detect(axiom, "doid#derives")) %>%
    count(tag) %>%
    arrange_by_tag()
```

It's limited to tags at the end of 2018. I'll verify that those have been fixed in a minute. Right now, I need to see if there are other terms like that.

```{r}
unexpected_axiom$axiom %>%
    stringr::str_extract_all("doid#[a-zA-z_]+") %>%
    unlist() %>%
    unique()
```

Yep. And is that in current use?

```{r}
unexpected_axiom %>%
    filter(str_detect(axiom, "doid#has")) %>%
    count(tag) %>%
    arrange_by_tag()
```

Nope. It's also from the end of 2018. _That must've been a mess to fix._

If I temporarily remove them...
```{r}
unexpected_axiom %>%
    dplyr::mutate(axiom = stringr::str_remove_all(axiom, "doid#[a-zA-z_]+")) %>%
    identify_unexpected_axiom()
```

...only some unexpected `/` remain, which are likely typos.

So the **unusual characters in axioms are attributable to:**

1. OBO URIs instead of CURIEs
2. SO classes with `#`
3. Temporary DO classes with `#`
4. A `/` typo.


# Tidy & Write to Google Sheets

**NEED UPDATED APPROACH/OUTPUT**
_These sheets are NOT easily read or reviewed... too many releases included._

```{r}
axiom_tidy <- dplyr::left_join(raw_data, tag_order, by = "tag") %>%
    dplyr::mutate(index = "x") %>%
    pivot_wider(
        id_cols = c(id, type, axiom),
        names_from = tag,
        values_from = index
    )
```


```{r}
googlesheets4::write_sheet(
    dplyr::filter(axiom_tidy, type == "equivalentClass"),
    "https://docs.google.com/spreadsheets/d/1qqq4W7SFmWQ5RjTK5SHFEwErj9-vVNd0MH3vuj4ElJE/edit?usp=sharing",
    "equivalentClass"
)

googlesheets4::write_sheet(
    dplyr::filter(axiom_tidy, type == "subClassOf"),
    "https://docs.google.com/spreadsheets/d/1qqq4W7SFmWQ5RjTK5SHFEwErj9-vVNd0MH3vuj4ElJE/edit?usp=sharing",
    "subClassOf"
)
```




