---
title: "Produce Candidate Definitions for DOIDs without them"
author: "J. Allen Baron"
date: "2021-10-28"
output:
    html_document:
        toc: true
        toc_float: true
        df_print: paged
---

```{r setup, include = FALSE}
library(here)
library(virtuoso)
library(parallel)
```

# PURPOSE
To identify candidate definitions from MESH and NCI Thesaurus for DOIDs without definitions.


# Data Setup (Manual Execution)

## Download Data

1. Copy doid.owl (release: v2021-10-11) from HumanDiseaseOntology git repo to data.
2. Download NCI Thesaurus OWL file (asserted version; release 21.09d) to data from https://evs.nci.nih.gov/evs-download/thesaurus-downloads.
    - NOTE: .zip can't be read by `virtuoso` bulk database uploader, so I unzipped and recompressed it as .gz file.
3. Download MESH N-triples file to data from https://hhs.github.io/meshrdf/ ftp site (release: 2021-10-28, updated nightly).

```{r}
# data files
doid_owl <- here::here("data/doid_v2021-10-11.owl")
nci_owl <- here::here("data/Thesaurus.owl.gz")
mesh_nt <- here::here("data/mesh.nt.gz")
```

```{r eval = FALSE, include = FALSE}
# extra if using NCI thesaurus flat file
nci_tsv <- here::here("data/Thesaurus_21.09d.FLAT.zip")
nci_colnames <- c("code", "concept_name", "parents", "synonyms", "definition",
                  "display_name", "concept_status", "semantic_type")
nci <- readr::read_tsv(nci_tsv, col_names = nci_colnames)
```


## Setup a Virtuoso Database

I installed Virtuoso using `scripts/setup_virtuoso.R` and default values. That script and SPARQL queries herein rely on the `virtuoso` R package.

I chose to load the 3 rdf files as individual graphs so that I could explore them separately and avoid unexpected results from queries finding hits in multiple data sources.

```{r}
# start database and initiate a connection
virtuoso::vos_start()
vcon <- virtuoso::vos_connect()

# list graphs (i.e. URIs)
virtuoso::vos_list_graphs(vcon)
```

```{r eval = FALSE}
# import data into db, ran interactively once
virtuoso::vos_import(
    con = vcon,
    files = doid_owl,
    graph = "doid",
    n_cores = dplyr::if_else(
        parallel::detectCores() > 2,
        parallel::detectCores() - 2,
        1
    )
)

virtuoso::vos_import(
    con = vcon,
    files = mesh_nt,
    graph = "mesh",
    n_cores = dplyr::if_else(
        parallel::detectCores() > 2,
        parallel::detectCores() - 2,
        1
    )
)

virtuoso::vos_import(
    con = vcon,
    files = nci_owl,
    graph = "nci",
    n_cores = dplyr::if_else(
        parallel::detectCores() > 2,
        parallel::detectCores() - 2,
        1
    )
)
```


# DOIDs without definitions

I extracted the DOIDs without definitions, excluding obsolete terms, along with all annotated xrefs for further analysis and use. I did not use the `src/sparql/extra/DO_no_defs.rq` SPARQL query (it has the same terms but results in multiple rows per term because it represents parents). Instead, I directly excluded obsolete terms and did not extract parent information.
```{r}
query_no_def_xref <-
    '# Query non-deprecated DOIDs without definitions
    PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
    PREFIX owl: <http://www.w3.org/2002/07/owl#>
    PREFIX obo: <http://purl.obolibrary.org/obo/>
    PREFIX oboInOwl: <http://www.geneontology.org/formats/oboInOwl#>

    SELECT ?doid ?do_name ?xref
    FROM <doid>
    WHERE {
        ?class a owl:Class ;
            oboInOwl:id ?doid ;
            rdfs:label ?do_name .
        OPTIONAL { ?class oboInOwl:hasDbXref ?xref . }
        # include only those missing definitions & not deprecated
        FILTER NOT EXISTS { ?class obo:IAO_0000115 ?def . }
        FILTER NOT EXISTS { ?class owl:deprecated ?any . }
    }'

do_no_def <- virtuoso::vos_query(vcon, query_no_def_xref) %>%
    tibble::as_tibble() %>%
    dplyr::mutate(xref_ns = stringr::str_remove(xref, ":.*"))
```

There are **`r format(dplyr::n_distinct(do_no_def$doid), big.mark = ",")` DOIDs without definitions**. Of these, `r dplyr::n_distinct(do_no_def$doid[is.na(do_no_def$xref)])` have NO xrefs. See the list below:
    ```{r}
dplyr::filter(do_no_def, is.na(xref))
```
Here's a quick snapshot of the xrefs:
```{r}
dplyr::count(do_no_def, xref_ns) %>%
    dplyr::arrange(desc(n))
```

```{r}
nci_mesh_umls <- do_no_def %>%
    dplyr::filter(xref_ns %in% c("MESH", "NCI", "UMLS_CUI")) %>%
    dplyr::group_by(doid) %>%
    dplyr::summarize(
        nci_mesh = any(xref_ns %in% c("MESH", "NCI")),
        umls = any(xref_ns == "UMLS_CUI")
    )

nm_no_umls <- nci_mesh_umls %>%
    dplyr::filter(nci_mesh & !umls)
```

I would assume that most NCI and MESH terms are also in UMLS. Of the `r format(dplyr::n_distinct(nci_mesh_umls$doid[nci_mesh_umls$nci_mesh]), big.mark = ",")` DOIDs with NCI or MESH xrefs there are `r format(dplyr::n_distinct(nm_no_umls$doid), big.mark = ",")` DOIDs _WITHOUT_ UMLS xrefs. Those DOIDs are:
```{r}
dplyr::filter(do_no_def, doid %in% nm_no_umls$doid) %>%
    dplyr::group_by(doid, do_name) %>%
    dplyr::summarize(xref = paste0(xref, collapse = "|"), .groups = "drop")
```

And lastly, the number of DOIDs without definitions **with or without NCI/MESH xrefs** is:
```{r}
nci_mesh_xref <- do_no_def %>%
    dplyr::group_by(doid) %>%
    dplyr::summarize(
        has_nci_mesh_xref = any(xref_ns %in% c("MESH", "NCI"))
    )

nci_mesh_xref %>%
    dplyr::count(has_nci_mesh_xref)
```

That's about 1/5 of the DOIDs without definitions that NCI & MESH can't help with. Among those it appears most have xrefs to one of the ICD's or SNOMED (via UMLS). I'm not sure any of those will be accessible for definitions.
```{r}
doid_no_nci_mesh <- dplyr::filter(nci_mesh_xref, !has_nci_mesh_xref)$doid

do_no_nci_mesh <- do_no_def %>%
    dplyr::filter(doid %in% doid_no_nci_mesh)

do_no_nci_mesh %>%
    dplyr::count(xref_ns)
```

The small number of DOIDs without definitions with xrefs to EFO/GARD/OMIM are:
```{r}
dplyr::filter(do_no_nci_mesh, xref_ns %in% c("EFO", "GARD", "OMIM")) %>%
    dplyr::group_by(doid, do_name) %>%
    dplyr::summarize(xref = paste0(xref, collapse = "; "), .groups = "drop")
```


# Extract definitions from NCI & MESH

```{r}
query_new_def <-
    '# Query non-deprecated DOIDs without definitions
    PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
    PREFIX owl: <http://www.w3.org/2002/07/owl#>
    PREFIX obo: <http://purl.obolibrary.org/obo/>
    PREFIX oboInOwl: <http://www.geneontology.org/formats/oboInOwl#>
    PREFIX nci: <http://ncicb.nci.nih.gov/xml/owl/EVS/Thesaurus.owl#>
    PREFIX mesh: <http://id.nlm.nih.gov/mesh/>
    PREFIX meshv: <http://id.nlm.nih.gov/mesh/vocab#>

    SELECT ?doid ?do_name ?def ?xref
    FROM <doid>
    FROM <mesh>
    FROM <nci>
    WHERE {
        # DOID data
        ?class a owl:Class ;
            oboInOwl:id ?doid ;
            rdfs:label ?do_name ;
            oboInOwl:hasDbXref ?xref .
        # include only those missing definitions & not deprecated
        FILTER NOT EXISTS { ?class obo:IAO_0000115 ?any_def . }
        FILTER NOT EXISTS { ?class owl:deprecated ?any . }
        # include only NCI/MESH xrefs
        FILTER REGEX(STR(?xref), "(NCI|MESH).*")

        # xref definition data
        BIND(
            REPLACE(
                STR(?xref),
                "NCI:",
                "http://ncicb.nci.nih.gov/xml/owl/EVS/Thesaurus.owl#"
            ) as ?nci_uri
        )
        BIND(
            REPLACE(
                STR(?xref),
                "MESH:",
                "http://id.nlm.nih.gov/mesh/"
            ) as ?mesh_nci_uri
        )
        ?mesh_nci_uri a owl:Class .
        OPTIONAL {
            ?mesh_nci_uri meshv:scopeNote ?def .
        }
        OPTIONAL {
            ?mesh_nci_uri nci:P97 ?def .
            # remove obsolete/retired concepts from NCI
            FILTER NOT EXISTS {
                ?nci_uri nci:P310 ?old_concept .
                VALUES ?old_concept { "Obsolete_Concept" "Retired_Concept" }
            }
        }
    }'

do_nci_mesh <- virtuoso::vos_query(vcon, query_new_def) %>%
    tibble::as_tibble()
```
